{% extends 'base.html' %}
{% load static %}

{% block title %}
    Landing Page
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'profile_setup.css' %}">
{% endblock %}

{% block content %}
<main class="container">
    <h1>Profile</h1>
    <div class="profile-picture">
        <!-- Profile picture display with default fallback -->
        <img
            src="{{ profile_picture_url }}"
            alt="PFP HERE"
            id="profile-pic">


        <div class="dropdown">
            <button class="edit-picture-button" title="Edit">✏️</button>
            <div class="dropdown-menu" style="display: none;">
                <!-- Replace Photo Button -->
                <button class="dropdown-item" id="replace-profile-picture">Replace Photo</button>

                <!-- Delete Photo Button wrapped in a form -->
                <form method="POST" action="{% url 'profile_setup' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" name="delete_picture" class="dropdown-item" id="delete-photo">Delete Photo</button>
                </form>
            </div>
        </div>
        <!-- Hidden input for uploading a new file -->
        <input type="file" id="profile-pic-input" name="profile_picture" accept="image/*" style="display: none;">
    </div>

    <form method="POST" enctype="multipart/form-data" action="{% url 'profile_setup' %}">
        {% csrf_token %}
        {{ form.as_p }}
        <div class="form-group">
            <label for="school">School</label>
            <input type="text" id="school" name="school" value="{{ profile.school }}" required placeholder="e.g., Boston College">
        </div>
        <div class="form-group">
            <label for="graduation-year">Year of Graduation</label>
            <input type="number" id="graduation-year" name="graduation_year" value="{{ profile.graduation_year }}" required min="2024" max="2030" placeholder="e.g., 2025">
        </div>
        <div class="form-group">
            <label for="major1">Primary Major</label>
            <input type="text" id="major1" name="major1" value="{{ profile.major1 }}" required placeholder="e.g., Computer Science">
        </div>
        <div class="form-group">
            <label for="major2">Secondary Major (Optional)</label>
            <input type="text" id="major2" name="major2" value="{{ profile.major2 }}" placeholder="e.g., Finance">
        </div>
        <button type="submit">Save Profile</button>
    </form>
</main>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const editButton = document.querySelector('.edit-picture-button');
      const dropdownMenu = editButton.closest('.dropdown').querySelector('.dropdown-menu');
      const deletePhotoButton = document.getElementById('delete-photo');
      const profilePic = document.getElementById('profile-pic');
      const navbarProfilePic = document.getElementById('navbar-profile-pic');

      const replacePhotoButton = document.getElementById('replace-profile-picture');
      const uploadPictureInput = document.getElementById('profile-pic-input');

      // Toggle dropdown menu
      editButton.addEventListener('click', (event) => {
          event.stopPropagation();
          dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
          console.log("Dropdown menu visibility toggled. Current state:", dropdownMenu.style.display);
      });

      // Handle Replace Photo
      replacePhotoButton.addEventListener('click', () => {
          console.log("Replace Photo button clicked");
          uploadPictureInput.click(); // Open file input dialog
      });

      // Update profile picture preview after file upload
      uploadPictureInput.addEventListener('change', (event) => {
          const [file] = event.target.files;
          console.log("File selected:", file);

          if (file) {
              updateProfilePictures(file); // Update the preview immediately
              const previewURL = URL.createObjectURL(file);
              console.log("File URL generated:", previewURL);
              profilePic.src = previewURL;
              if (navbarProfilePic) {
                  navbarProfilePic.src = previewURL;
              }
              console.log("Profile picture updated with preview URL:", previewURL);


              // Create a FormData object to send the file via AJAX
              const formData = new FormData();
              formData.append('profile_picture', file); // Append the selected file
              formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); // CSRF token for security

              console.log("FormData entries:", [...formData.entries()]);


              // Send the file to the server
              fetch("{% url 'profile_setup' %}", {
                  method: 'POST',
                  body: formData,
              })
              .then(response => {
                  if (response.ok) {
                      console.log("Profile picture successfully updated on the server.");
                  } else {
                      console.error("Failed to update profile picture on the server.");
                  }
              })
              .catch(error => {
                  console.error("Error during the profile picture update:", error);
              });

              dropdownMenu.style.display = 'none'; // Hide dropdown
              console.log("Dropdown menu hidden after file selection.");

          }
      });


      // Handle Delete Photo
      deletePhotoButton.addEventListener('click', (event) => {
          event.preventDefault();
          const defaultPic = "{% static 'default_profile_pic.png' %}";
          profilePic.src = defaultPic;
          if (navbarProfilePic) {
              navbarProfilePic.src = defaultPic;
          }
          console.log("Profile picture set to default.");

          deletePhotoButton.closest('form').submit();
          console.log("Delete photo form submitted.");

      });

      // Close dropdown if clicked outside
      document.addEventListener('click', (event) => {
          if (!event.target.closest('.dropdown')) {
              dropdownMenu.style.display = 'none';
              console.log("Dropdown menu closed due to click outside.");

          }
      });
  });

</script>

{% endblock %}
